#chip 16F877A, 20
#config HS_OSC, WDT_OFF, LVP_OFF

#define button PORTB.1
#define LED PORTB.2

#define PulsePeriod 1 10us

#define Peak 0xdd 'Highest value recorded from potentiometer
#define GraphStep 27

dir A0 in
dir B1 in
dir B2 out
dir C 0
Counter = 0

Main:
 Counter = Counter + 1
 ControlValue = ReadAD(AN0)
 if Counter > ControlValue then set led off
 if Counter => Peak then set led on: Counter = 0
 Temp = ControlValue/GraphStep
 BarGraph Temp
 Wait PulsePeriod
 if button off then Flicker
goto Main

sub Flicker
 wait until button on
 wait 10 ms
 StopFlicker = 0

FlickerStart:
 for Temp = 1 to 100
  for Temp3 = 1 to 20
   if button off then goto EndFlicker
   for Temp2 = 1 to 100
    set led off
    if Temp > Temp2 then set led on
    wait PulsePeriod
   next
  next
 next
 for Temp = 1 to 100
  for Temp3 = 1 to 20
   if button off then goto EndFlicker
   for Temp2 = 1 to 100
    set led on
    if Temp > Temp2 then set led off
    wait PulsePeriod
   next
  next
 next
goto FlickerStart

EndFlicker:
wait until button on
wait 10 ms
end sub

sub BarGraph (level)
 PORTC = 0
 if level >= 1 then set PORTC.0 ON
 if level >= 2 then set PORTC.1 ON
 if level >= 3 then set PORTC.2 ON
 if level >= 4 then set PORTC.3 ON
 if level >= 5 then set PORTC.4 ON
 if level >= 6 then set PORTC.5 ON
 if level >= 7 then set PORTC.6 ON
 if level >= 8 then set PORTC.7 ON
end sub